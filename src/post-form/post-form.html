<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-meta/iron-meta.html">

<dom-module id="post-form">
    <template>
        <style>
            .form-container {
                width: 50%;
            }

            .pyramid-card {
                outline: 3px solid salmon;
                width: 600px;
                display: flex;
                flex-direction: column;
                align-items: center;
                background-color: white;
            }

            @media (max-width: 768px) {
                .pyramid-card {
                    width: 100%;
                }
            }

            #pyramid-icon {
                height: 100px;
            }

            paper-input {
                width: 70%;
            }

            paper-textarea {
                width: 90%;
            }

            paper-button {
                margin-top: 16px;
            }

            .paper__toast {
                /* Fixed align to center*/
                margin-left: calc(50vw - 150px);
                --paper-toast-background-color: green;
                --paper-toast-color: white;
                /*Mixin applied to the paper-toast*/
                --paper-font-common-base: {
                    text-align: center;
                }
            }
        </style>

        <iron-meta id="meta"></iron-meta>

        <iron-form id="iron">
            <form>
                <div class="pyramid-card">
                    <img id="pyramid-icon" src="../../images/piramide-maya.svg" alt="pyramid">
                    <paper-input value={{titleInputVal::input}} invalid="{{ivalidTitle}}" pattern=".{1,140}" required auto-validate error-message="This field must be between 1 and 140 characters long"
                        label="Title"></paper-input>

                    <paper-textarea rows$="[[rows]]" value={{textAreaValue::input}} invalid="{{invalidPost}}" maxlength="240" required auto-validate
                        error-message="This field must be between 1 and 240 characters long" label="Post"></paper-textarea>

                    <paper-button disabled="[[disableBtn]]" raised on-click="submitForm">Submit</paper-button>
                </div>
            </form>
        </iron-form>

        <paper-toast id="toast" class="paper__toast" text="Post creado correctamente." horizontalAlign="auto"></paper-toast>



    </template>
    <script>
        (function postForm(customElements) {
            class PostForm extends Polymer.Element {
                static get is() {
                    return 'post-form'
                }

                static get properties() {
                    return {
                        users: Array,
                        ivalidTitle: Boolean,
                        invalidPost: Boolean,
                        titleInputVal: String,
                        textAreaValue: String,
                        disableBtn: {
                            computed: 'isFormValid(ivalidTitle, invalidPost, titleInputVal, textAreaValue)'
                        },
                        rows: {
                            value: 2
                        },
                        currentPosts:{
                            type: Object,
                            reflectToAttribute: true
                        }
                    }
                }

                submitForm() {
                    console.log("Crear post");

                    let dataUser = this.$.meta.byKey('userInfo');
                    let jsonString = JSON.stringify({
                        user: {
                            email: dataUser.email
                        },
                        post: {
                            title: this.titleInputVal,
                            body: this.textAreaValue
                        }
                    });


                    console.log("dataUser", dataUser);
                    console.log("title", this.titleInputVal);
                    console.log("body", this.textAreaValue);
                    console.log("jsonString", jsonString);

                    fetch('https://posts-services.herokuapp.com/posts', {
                            method: 'POST',
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            },
                            body: jsonString
                        })
                        .then((resp) => resp.json()) // Transform the data into json
                        .then((d) => {

                            console.log("data post", d);

                            this.$.iron.reset();

                            this.$.toast.open();

                            console.log('pather',this.pather);

                            let posts;
                            d.forEach(user => {
                                if (user.email == dataUser.email) {
                                    posts = user.posts;
                                }
                            });

                            console.log("como va 1",this.pather.currentPosts);

                            let lastPost = posts[posts.length -1 ];

                            this.pather.push('currentPosts',lastPost);

                            console.log("como va 2",this.pather.currentPosts);



                        })
                        .catch(e => {
                            console.log(
                                `Parece que hubo un problema ===>\n CÃ³digo de estado: ${e.status}\n Mensaje: ${e.statusText}`
                            );
                        });



                    //



                }

                isFormValid(invalidTitle, invalidPost, titleInputVal, textAreaValue) {
                    if (!titleInputVal || !textAreaValue) {
                        return true
                    }
                    if (invalidTitle || invalidPost) {
                        return true
                    }
                    return false
                }
            }
            customElements.define(PostForm.is, PostForm);

        })(window.customElements);
    </script>
</dom-module>