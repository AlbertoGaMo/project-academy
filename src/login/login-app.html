<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/utils/render-status.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../src/color/color-design.html">

<dom-module id="login-app">
    <template>
        <style include="color-design">
            :host {
                height: 100%;
                overflow: hidden;
                user-select: none;
                display: -ms-flexbox;
                display: -webkit-flex;
                display: flex;
                -ms-flex-direction: column;
                -webkit-flex-direction: column;
                flex-direction: column;
                -ms-flex-align: center;
                -webkit-align-items: center;
                align-items: center;
                -ms-flex-pack: center;
                -webkit-justify-content: center;
                justify-content: center;
                box-sizing: border-box;
            }

            .paper-card{
                --paper-card-background-color: var(--card-background-color);
                --paper-card:{
                    margin: auto;
                    padding: 30px;
                    border: 1px solid rgba(0,0,0,0.2);
                };
                --paper-card-header: {
                    padding: 20px;
                    margin: 10px 110px;
                };
                --paper-card-actions:{
                    border: none;
                    display: -ms-flexbox;
                    display: -webkit-flex;
                    display: flex;
                    -ms-flex-pack: center;
                    -webkit-justify-content: center;
                    justify-content: center;
                }
            }

            .paper__input{
                margin-bottom: 30px;
                --primary-text-color: var(--text-primary-color);
                /*placeholder*/
                --paper-input-container-color: var(--input-placeholder-color);
                --paper-input-container-focus-color: var(--primary-text-color);
                --paper-input-container-invalid-color: red;
                border: var(--input-container-border);
                border-radius: 5px;

                /* Reset some defaults */
                --paper-input-container: { padding: 0;};
                --paper-input-container-underline: { display: none; height: 0;};
                /*--paper-input-container-underline-focus: { display: none; };*/

                /* New custom styles */
                --paper-input-container-input: {
                    box-sizing: border-box;
                    font-size: inherit;
                    padding: 4px;
                    background: var(--primary-background-color);
                };
                --paper-input-container-input-focus: {
                    /*background: var(--primary-background-color);*/
                };
                --paper-input-container-input-invalid: {
                    background: rgba(255, 0, 0, 0.3);
                };
                --paper-input-container-label: {
                    top: -10px;
                    left: 5px;
                    background: transparent;
                    padding: 2px;
                    font-weight: bold;
                    font-size: 18pt;
                    color: var(--primary-text-color);
                };
                --paper-input-container-label-floating: {
                    width: auto;
                };
            }

            .paper__button {
                width: 100%;
                margin: 0;
                background-color: var(--default-primary-color);
                color: white;
                font-weight: 500 !important;
                --paper-button-raised-keyboard-focus: {
                    color: white !important;
                    font-weight: 500 !important;
                };
            }

        </style>

        <app-location route="{{route}}"></app-location>
        <app-route
                route="{{route}}"
                pattern="/:page"
                data="{{routeData}}"
                tail="{{subroute}}">
        </app-route>


            <paper-card class="paper-card" elevation="5" animatedShadow fadeImage image="../../images/logo.png" alt="logo">

                <div class="card-content">

                    <paper-input id="userMail" class="paper__input" value="{{mail::input}}" label="Usuario" placeholder="ejemplo@email.com" required error-message="Campo email no debe ir vacio.">

                        <iron-icon icon="mail" slot="prefix"></iron-icon>
                        <paper-icon-button slot="suffix" on-click="_clearInput" icon="clear" alt="clear" title="clear" ></paper-icon-button>

                    </paper-input>

                    <paper-input id="userPwd" class="paper__input" type="password" value="{{pwd::input}}" always-float-label label="Contraseña" required error-message="Campo contraseña no debe ir vacio." ></paper-input>

                </div>

                <div class="card-actions">

                    <div>

                        <template is="dom-if" if="[[!loading]]">
                            <paper-button  class="paper__button" on-click="_onClickDoLogin">Iniciar sesión</paper-button>
                        </template>

                        <template is="dom-if" if="[[loading]]">
                            <paper-spinner active ></paper-spinner>
                        </template>

                    </div>
                </div>
            </paper-card>

        <iron-pages selected="[[routeData.view]]" attr-for-selected="name">
            <dashboard-base name="dashboard" route="{{route}}"></dashboard-base>
        </iron-pages>





    </template>

    <script>
        /**
         * @customElement
         * @polymer
         */
        class LoginApp extends Polymer.Element {
            static get is() { return 'login-app'; }
            static get properties() {
                return {
                    page: {
                        type: String,
                        reflectToAttribute: true,
                        observer: '_pageChanged',
                    },
                    routeData: Object,
                    subroute: Object,
                    loading: {
                        type: Boolean,
                        value: false
                    },
                    user: {
                        type: Object,
                        notify: true,
                        value: {
                            mail: '',
                            pwd: ''
                        }
                    },
                    mail: {
                      type: String,
                      value: ''
                    },
                    pwd: {
                        type: String,
                        value: ''
                    },
                    error:{
                        type: Object,
                        value: {
                            mail:'',
                            pwd:''
                        }
                    }
                };
            }
            static get observers() {
                return [
                    '_routePageChanged(routeData.page)'
                ]
            }

            //  === Callbacks ===>

            /**
             * Ciclos de vida (Callbacks)
             *
             * @descriptor
             *
             * La especificación de elemento personalizado proporciona un conjunto de devoluciones de llamada
             * llamadas "custom element reactions" que le permiten ejecutar código de usuario en respuesta a ciertos
             * cambios de ciclo de vida.
             *
             */

            /** @ready
             * Invocada la primera vez que el elemento se agrega al DOM.
             */
            ready() {
                // Llamada al método de la superclase "ready()". Esto es necesario para que Polymer pueda engancharse en el ciclo de vida del elemento.
                super.ready();
                /**
                 * @afterNextRender Encola una devolución de llamada que se ejecutará después de la siguiente representación,
                 * equivalente a una tarea (setTimeout) después de la siguiente requestAnimationFrame.
                 *
                 * @description
                 *
                 * Este método es útil para ajustar el rendimiento del primer render de un elemento o aplicación al diferir
                 * el trabajo no crítico hasta después de la primera pintura.
                 * El trabajo típico que no es crítica, puede incluir la adición de detectores de eventos UI y atributos aria.
                 */

                Polymer.RenderStatus.afterNextRender(this, () => {
                    this.parentElement.firstElementChild.remove();
                    this.removeAttribute('unresolved');
                });
            }
            _routePageChanged(page) {
                this.page = page || 'login';
            }
            _pageChanged(page,oldPage) {

                console.log("page",page,oldPage);

                if (page != null) {
                    // home route is eagerly loaded
                    if (page !== 'login') {
                        //Polymer.importHref(href, onload, onerror, optAsync){}
                        /*Polymer.importHref(
                            this.resolveUrl('../views/view-' + page + '.html'),
                            ()=> {
                                if(page==="detail"){
                                    const page_detail = this.$.viewDetailPage;
                                    page_detail._setDetail();
                                }
                            }, null, true);*/
                    }
                }
            }
            /**
             *
             * @private
             */
            _checkMail(e){
                let re = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
                return re.test(e);
            }
            /**
             *
             * @private
             */
            _clearInput(){
                this.mail = '';
            }
            /**
             *
             * @private
             */
            _emptyInputs(inputs) {

                let empty = false;

                inputs.forEach((input)=> {

                    if(!input.validate()){
                        input.setAttribute('auto-validate','');
                        empty = true;
                    }

                });

                return empty;
            }
            _onClickDoLogin(){

                if(this._emptyInputs(this.shadowRoot.querySelectorAll('paper-input'))){return; }
                if(!this._checkMail(this.mail)){
                    this.shadowRoot.querySelector('#userMail').setAttribute('error-message','Formato de correo no válido.');
                    this.shadowRoot.querySelector('#userMail').invalid = true;
                    return;
                }else{
                    this.shadowRoot.querySelector('#userMail').setAttribute('error-message','Campo email no debe ir vacio.');
                    this.shadowRoot.querySelector('#userMail').invalid = false;
                }
                this.loading = !this.loading;
                this._fetch();
            }
            _fetch(){

                this.set('user',{
                    mail: this.mail,
                    pwd: this.pwd,
                });
/*
                fetch('falta_url_anuar',{ // Url
                    method: 'post', // Solicitud de tipo "POST"
                    body: JSON.stringify({user:this.user})
                })
                    .then(r => {
                        console.log('r',r);
                        if (!r.ok) { throw r;}
                        if (r.status !== 200) { throw r;}


                    })
                    .catch(e => {
                        console.log(`Parece que hubo un problema ===>\n Código de estado: ${e.status}\n Mensaje: ${e.statusText}`);
                        this.loading = !this.loading;
                        this.mail = '';
                        this.pwd = '';
                    });*/

                document.location = '../../src/dashboard/dashboard-base.html';

            }
        }

        window.customElements.define(LoginApp.is, LoginApp);
    </script>
</dom-module>
